#!/bin/bash

# ==============================================================================
# TECHTON - Enterprise Active Directory Stress Testing Suite
# Version: 1.0 (Hybrid: Docker + Local Host Mode)
# Property of: Badan Riset dan Inovasi Nasional (BRIN)
# License: MIT
# ==============================================================================

# --- CONFIGURATION ---
RETENTION_DAYS=30
DOCKER_IMAGE_JM="justb4/jmeter:5.5"
DOCKER_IMAGE_K6="techton-k6:latest"
JVM_ARGS="-Xms1g -Xmx4g" # JMeter Memory

# --- ENVIRONMENT SETUP ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
BIN_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
PROJECT_ROOT="$(dirname "$BIN_DIR")"
LOCAL_K6="$BIN_DIR/k6"

# Templates
TEMPLATE_JM_LOGIN="$PROJECT_ROOT/templates/ad_load.jmx"
TEMPLATE_JM_SEARCH="$PROJECT_ROOT/templates/ad_search.jmx"
TEMPLATE_K6_LOGIN="$PROJECT_ROOT/templates/ad_load_k6.js"

RESULTS_DIR="$PROJECT_ROOT/results"
HISTORY_FILE="$RESULTS_DIR/history.csv"
RUN_FILE_JMX="$RESULTS_DIR/run_current.jmx"
RUN_FILE_JS="$RESULTS_DIR/run_current.js"
TEMP_LOG="/tmp/techton_out.txt"

# --- HUD PALETTE ---
BOLD='\033[1m'
CLR_CYAN='\033[38;5;51m'
CLR_MAGENTA='\033[38;5;201m'
CLR_GREEN='\033[38;5;82m'
CLR_YELLOW='\033[38;5;226m'
CLR_RED='\033[38;5;196m'
CLR_GREY='\033[38;5;244m'
CLR_WHITE='\033[38;5;255m'
NC='\033[0m'

mkdir -p "$RESULTS_DIR"
if [ ! -f "$HISTORY_FILE" ]; then
    echo "Timestamp,Target,Mode,Users,Duration,AvgLatency,Errors,Status,Path" > "$HISTORY_FILE"
fi

# --- UTILS ---
cleanup() {
    tput cnorm
    if docker ps -q --filter "name=techton_" | grep -q .; then
        echo -e "\n ${CLR_RED}[!] EMERGENCY STOP: Killing active containers...${NC}"
        docker ps -q --filter "name=techton_" | xargs -r docker stop &> /dev/null
    fi
    # Also kill local k6
    pkill -f "$LOCAL_K6"
    
    [ -f "$RUN_FILE_JMX" ] && rm -f "$RUN_FILE_JMX"
    [ -f "$RUN_FILE_JS" ] && rm -f "$RUN_FILE_JS"
    [ -f "$TEMP_LOG" ] && rm -f "$TEMP_LOG"
    echo -e "\n ${CLR_GREY}System Terminated Safely.${NC}"
    exit 0
}
trap cleanup SIGINT SIGTERM

perform_housekeeping() {
    count=$(find "$RESULTS_DIR" -mindepth 1 -maxdepth 1 -type d -mtime +$RETENTION_DAYS | wc -l)
    if [ "$count" -gt 0 ]; then
        echo -e "${CLR_GREY} System Maintenance: Cleaning $count expired logs...${NC}"
        find "$RESULTS_DIR" -mindepth 1 -maxdepth 1 -type d -mtime +$RETENTION_DAYS -exec rm -rf {} +
    fi
}

draw_banner() {
    clear
    echo -e "${CLR_CYAN}┌──────────────────────────────────────────────────────────────────────┐"
    echo -e "│ ${BOLD}${CLR_WHITE}TECHTON ${CLR_CYAN}v1.0${NC}${CLR_CYAN}                                                       │"
    echo -e "│ ${CLR_GREY}Enterprise Grade Active Directory Resilience Audit Tool              ${CLR_CYAN}│"
    echo -e "│ ${CLR_GREY}Property of National Research and Innovation Agency (BRIN)         ${CLR_CYAN}│"
    echo -e "└──────────────────────────────────────────────────────────────────────┘${NC}"
}

draw_main_menu() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}MAIN OPERATIONAL INTERFACE${NC}"
    echo -e " ${CLR_GREY}───────────────────────────${NC}"
    echo -e "  ${CLR_CYAN}[1]${NC} INITIALIZE NEW ATTACK VECTOR"
    echo -e "  ${CLR_CYAN}[2]${NC} ACCESS HISTORICAL AUDIT LOGS"
    echo -e "  ${CLR_CYAN}[3]${NC} MONITOR ACTIVE SUB-PROCESSES"
    echo -e "  ${CLR_CYAN}[q]${NC} QUIT SYSTEM"
    echo -e "\n ${CLR_GREY}Select option...${NC}"
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
}

# --- MODULES ---
view_history() {
    while true;
    do
        draw_banner
        echo -e "\n ${BOLD}${CLR_WHITE}HISTORICAL AUDIT LOGS${NC}"
        echo -e " ${CLR_GREY}─────────────────────${NC}"
        printf " ${BOLD}${CLR_CYAN}%-3s  %-16s  %-15s  %-6s  %-8s  %-8s  %-8s${NC}\n" "ID" "TIMESTAMP" "TARGET" "MODE" "LOAD" "LATENCY" "STATUS"
        echo -e " ${CLR_GREY}────────────────────────────────────────────────────────────────────────────${NC}"
        
        mapfile -t lines < <(tail -n +2 "$HISTORY_FILE")
        if [ ${#lines[@]} -eq 0 ]; then
            echo -e " ${CLR_YELLOW}No records found in database.${NC}"
        else
            i=1
            for line in "${lines[@]}"; do
                IFS=',' read -r ts target mode users dur lat err stat path <<< "$line"
                # Compatibility check
                if [ -z "$path" ]; then path=$stat; stat=$err; err=$lat; lat=$dur; dur=$users; users=$mode; mode="LOGIN"; fi
                
                clean_ts=$(echo "$ts" | sed 's/_/ /g' | cut -c1-16)
                status_display="$stat"
                if [ ! -d "$path" ]; then status_display="${CLR_GREY}EXPIRED${NC}"; 
                else
                     case "$stat" in
                        PASS)  status_display="${CLR_GREEN}${stat}${NC}" ;; 
                        WARN)  status_display="${CLR_YELLOW}${stat}${NC}" ;; 
                        *)     status_display="${CLR_RED}${stat}${NC}" ;; 
                    esac
                fi
                printf " ${CLR_CYAN}%02d${NC}   %-16s  %-15s  %-6s  %-8s  %-8s  %-8s\n" "$i" "$clean_ts" "$target" "$mode" "$users" "${lat}ms" "$status_display"
                ((i++))
            done
        fi
        echo -e "\n ${CLR_GREY}Enter ID for detailed report or [b] to Back...${NC}"
        printf " ${BOLD}${CLR_CYAN}>> ${NC}"
        read choice
        [[ "$choice" == "b" || "$choice" == "q" ]] && return
    done
}

check_processes() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}SYSTEM PROCESS MONITOR${NC}"
    echo -e " ${CLR_GREY}──────────────────────${NC}"
    active=$(docker ps --format "table {{.Names}}\t{{.Status}}" | grep "techton")
    local_proc=$(pgrep -a k6)
    
    if [ -z "$active" ] && [ -z "$local_proc" ]; then 
        echo -e " ${CLR_GREEN}System status: Nominal.${NC}"
    else
        echo -e " ${CLR_RED}Active sessions:${NC}"
        [ ! -z "$active" ] && echo "$active"
        [ ! -z "$local_proc" ] && echo "Local K6 PID: $local_proc"
        
        read -p " Terminate? (y/n): " k
        if [[ "$k" == "y" ]]; then 
            docker ps -q --filter "name=techton" | xargs -r docker stop &>/dev/null
            pkill -f "$LOCAL_K6"
            echo -e " ${CLR_GREEN}Terminated.${NC}"
        fi
    fi
    read -p " Enter to return..."
}

ensure_k6_image() {
    if [[ "$(docker images -q $DOCKER_IMAGE_K6 2> /dev/null)" == "" ]]; then
        echo -e "\n ${CLR_YELLOW}[!] K6 Image ($DOCKER_IMAGE_K6) not found.${NC}"
        echo -e " ${CLR_GREY}Building it now (this may take a few minutes)...${NC}"
        docker build -t "$DOCKER_IMAGE_K6" -f "$PROJECT_ROOT/docker/Dockerfile" "$PROJECT_ROOT/docker"
        if [ $? -ne 0 ]; then
            echo -e "\n ${CLR_RED}[X] Build Failed.${NC} Please check Dockerfile or network."
            read -p " Press Enter..."
            return 1
        fi
        echo -e " ${CLR_GREEN}Build Success!${NC}"
    fi
    return 0
}

start_test() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}ATTACK VECTOR INITIALIZATION${NC}"
    echo -e " ${CLR_GREY}─────────────────────────────${NC}"
    
    # 0. Select Environment
    echo -e " ${CLR_WHITE}Select Environment:${NC}"
    echo -e " ${CLR_CYAN}[1]${NC} Docker Container (Isolated, Recommended)"
    echo -e " ${CLR_CYAN}[2]${NC} Host / Local System (Direct Network Access)"
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
    read env_choice
    env_choice=${env_choice:-1}
    
    # 1. Select Engine
    echo -e "\n ${CLR_WHITE}Select Engine:${NC}"
    if [[ "$env_choice" == "1" ]]; then
        echo -e " ${CLR_CYAN}[1]${NC} Apache JMeter (Standard)"
    fi
    echo -e " ${CLR_CYAN}[2]${NC} K6 (Experimental, Go-based, High Performance)"
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
    read engine_choice
    engine_choice=${engine_choice:-1}
    if [[ "$env_choice" == "2" ]]; then engine_choice=2; fi # Force K6 for Local if JMeter not setup

    # 2. Select Attack Mode
    echo -e "\n ${CLR_WHITE}Select Mode:${NC}"
    echo -e " ${CLR_CYAN}[1]${NC} AUTHENTICATION STORM (CPU Stress) - Simulates Boot Storm"
    if [[ "$engine_choice" == "1" ]]; then
        echo -e " ${CLR_CYAN}[2]${NC} DIRECTORY SEARCH     (RAM Stress) - Simulates Query Load"
    fi
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
    read mode_choice
    
    TEMPLATE_USE="$TEMPLATE_JM_LOGIN"
    MODE_NAME="LOGIN"
    
    if [[ "$engine_choice" == "1" ]]; then
        if [[ "$mode_choice" == "2" ]]; then TEMPLATE_USE="$TEMPLATE_JM_SEARCH"; MODE_NAME="SEARCH"; fi
    else
        TEMPLATE_USE="$TEMPLATE_K6_LOGIN"
        MODE_NAME="LOGIN-K6"
        if [[ "$env_choice" == "1" ]]; then
            ensure_k6_image || return
        else
            if [ ! -f "$LOCAL_K6" ]; then
                echo -e "\n ${CLR_RED}[X] Local K6 binary not found at $LOCAL_K6.${NC}"
                read -p " Press Enter..."
                return
            fi
        fi
    fi
    
    # Inputs
    echo -e "\n ${BOLD}${CLR_WHITE}TARGET CONFIGURATION ($MODE_NAME)${NC}"
    printf " ${CLR_WHITE}Target IP     ${NC}[${CLR_GREY}192.168.100.236${NC}]: " ; read t_ip ; t_ip=${t_ip:-192.168.100.236}
    printf " ${CLR_WHITE}Admin Account ${NC}[${CLR_GREY}tester${NC}] (User only): " ; read u_name ; u_name=${u_name:-tester}
    def_dn="CN=$u_name,OU=User,OU=BRIN,DC=net,DC=brin,DC=go,DC=id"
    printf " ${CLR_WHITE}Use DN?       ${NC}[${CLR_GREY}y/n${NC}]: " ; read c_dn ; c_dn=${c_dn:-y}
    if [[ "$c_dn" == "y" ]]; then u_dn=$def_dn; else printf " ${CLR_WHITE}Manual DN     ${NC}: "; read u_dn; fi
    printf " ${CLR_WHITE}Access Key    ${NC}(Hidden): " ; read -s pass ; echo ""
    printf " ${CLR_WHITE}Load Intensity${NC}[${CLR_GREY}10 Threads${NC}]: " ; read threads ; threads=${threads:-10}
    
    rampup=$((threads / 5)); [ $rampup -lt 1 ] && rampup=1
    duration=$((rampup + 60)); [ $duration -lt 30 ] && duration=30
    printf " ${CLR_WHITE}Duration (s)  ${NC}[${CLR_GREY}$duration${NC}]: " ; read dur_in ; duration=${dur_in:-$duration}
    
    echo -e "\n ${CLR_CYAN}SYSTEM READY. ENGAGE?${NC}"
    read -p " Press Enter..."
    
    TS=$(date +"%Y-%m-%d_%H-%M-%S")
    CONTAINER_NAME="techton_${TS//[:_-]/}"
    R_DIR="run_${TS}_${threads}u"
    C_R_DIR="$RESULTS_DIR/$R_DIR"
    mkdir -p "$C_R_DIR"

    # Execution Logic
    if [[ "$engine_choice" == "1" ]]; then
        # JMETER (DOCKER) LOGIC
        sed -e "s/__TARGET_IP__/$t_ip/g" -e "s/__ROOT_DN__/DC=net,DC=brin,DC=go,DC=id/g" \
            -e "s/__USER_DN__/$u_dn/g" -e "s/__PASSWORD__/$pass/g" \
            -e "s/__THREADS__/$threads/g" -e "s/__RAMPUP__/$rampup/g" \
            -e "s/__DURATION__/$duration/g" "$TEMPLATE_USE" > "$RUN_FILE_JMX"

        tput civis
        docker run --rm --name "$CONTAINER_NAME" \
          --memory="4g" --cpus="2.0" \
          -e JVM_ARGS="$JVM_ARGS" \
          -v "$PROJECT_ROOT:/tests" -w /tests \
          $DOCKER_IMAGE_JM -Jsummariser.interval=3 -n -t "results/run_current.jmx" \
          -l "results/$R_DIR/result.jtl" -e -o "results/$R_DIR/dashboard" 2>&1 | tee "$TEMP_LOG" | \
          awk -v target="$t_ip" -v users="$threads" -v duration="$duration" -v mode="$MODE_NAME" \
              -v c1="$CLR_CYAN" -v c2="$CLR_MAGENTA" -v c3="$CLR_GREEN" -v c4="$CLR_RED" \
              -v c5="$CLR_YELLOW" -v c6="$CLR_GREY" -v c7="$CLR_WHITE" -v nc="$NC" -v b="$BOLD" \
        ' 
          BEGIN { start = systime() }
          /summary \+ / {
              now = systime(); elapsed = now - start; if(elapsed>duration) elapsed=duration;
              pct = (elapsed/duration)*100; if(pct>100) pct=100;
              bw=50; f=int((pct/100)*bw); bar=""; for(i=0;i<f;i++) bar=bar "█"; for(i=f;i<bw;i++) bar=bar "░";
              spd="0/s"; lat="0"; err="0";
              for(i=1;i<=NF;i++){ if($i ~ /\/s$/) spd=$i; if($i=="Avg:") lat=$(i+1); if($i=="Err:") err=$(i+1); }
              printf "\033[2J\033[H"
              print c1 "┌──────────────────────────────────────────────────────────────────────┐"
              print "│ " b c7 "OPERATIONAL DASHBOARD (JMETER)" nc c1 "                                    │"
              print "├──────────────────────────────────────────────────────────────────────┤"
              printf "│  %-12s %-18s  %-10s %-20s │\n", "TARGET:", target, "MODE:", mode
              printf "│  %-12s %-18s  %-10s %-20s │\n", "LOAD:", users " THREADS", "DURATION:", duration "s"
              print "├──────────────────────────────────────────────────────────────────────┤"
              print "│    %-18s      %-18s      %-18s  |\n", "THROUGHPUT", "LATENCY", "ERROR COUNT"
              printf "│    " c5 "%-18s" nc "      " c2 "%-18s" nc "      " (err>0?c4:c3) "% -18s" nc "  |\n", spd, lat " ms", err
              print "├──────────────────────────────────────────────────────────────────────┤"
              printf "│  PROGRESS: %3d%%  " c1 "[%s]" nc "  %4ds / %-4ds |\n", pct, bar, elapsed, duration
              print "└──────────────────────────────────────────────────────────────────────┘"
              fflush()
          }
        '
        tput cnorm
        res=$(grep "summary =" "$TEMP_LOG" | tail -n 1)
        l=$(echo "$res" | awk -F 'Avg: ' '{print $2}' | awk '{print $1}'); l=${l:-0}
        e=$(echo "$res" | awk -F 'Err: ' '{print $2}' | awk '{print $1}'); e=${e:-0}
        
    else
        # K6 LOGIC (HOST OR DOCKER)
        sed -e "s/__TARGET_IP__/$t_ip/g" \
            -e "s/__USER_DN__/$u_dn/g" -e "s/__PASSWORD__/$pass/g" \
            -e "s/__THREADS__/$threads/g" -e "s/__RAMPUP__/$rampup/g" \
            -e "s/__DURATION__/$duration/g" "$TEMPLATE_USE" > "$RUN_FILE_JS"

        echo -e "${CLR_CYAN}Launching K6 ($env_choice)...${NC}"
        
        if [[ "$env_choice" == "1" ]]; then
             # Docker Mode
            docker run --rm -it --name "$CONTAINER_NAME" \
              -v "$PROJECT_ROOT:/tests" \
              $DOCKER_IMAGE_K6 run "results/run_current.js" | tee "$TEMP_LOG"
        else
             # Local Host Mode
             "$LOCAL_K6" run "$RUN_FILE_JS" | tee "$TEMP_LOG"
        fi
          
        # Simple Parse for History
        # k6 output is unstructured without --out json, but we just want to save simple stats
        # For now, we assume PASS if exit code 0
        l="0"; e="0" 
    fi

    s="PASS"; [ "$e" -gt 0 ] && s="FAIL"; [ "$s" == "PASS" ] && [ "$l" -gt 2000 ] && s="CRIT"; [ "$s" == "PASS" ] && [ "$l" -gt 500 ] && s="WARN";
    echo "$TS,$t_ip,$MODE_NAME,$threads,$duration,$l,$e,$s,$C_R_DIR" >> "$HISTORY_FILE"
    echo -e "\n ${BOLD}${CLR_WHITE}MISSION COMPLETE.${NC} STATUS: ${BOLD}$s${NC}"
    read -p " Press Enter to return..."
}

perform_housekeeping
while true; do
    draw_main_menu
    read choice
    case "$choice" in
        1) start_test ;; 2) view_history ;; 3) check_processes ;; q|Q) echo -e "\n${CLR_GREY}System Terminated.${NC}"; exit 0 ;;
    esac
done
