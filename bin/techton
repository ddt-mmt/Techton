#!/bin/bash

# ==============================================================================
# TECHTON - Enterprise Active Directory Stress Testing Suite
# Version: 1.0.0
# License: MIT
# ==============================================================================

# --- ENVIRONMENT SETUP ---
SOURCE=${BASH_SOURCE[0]}
while [ -L "$SOURCE" ]; do
  DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
BIN_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
PROJECT_ROOT="$(dirname "$BIN_DIR")"

TEMPLATE_FILE="$PROJECT_ROOT/templates/ad_load.jmx"
RESULTS_DIR="$PROJECT_ROOT/results"
HISTORY_FILE="$RESULTS_DIR/history.csv"
RUN_FILE="$RESULTS_DIR/run_current.jmx"
TEMP_LOG="/tmp/techton_out.txt"

# --- HUD COLOR PALETTE ---
BOLD='\033[1m'
CLR_CYAN='\033[38;5;51m'
CLR_MAGENTA='\033[38;5;201m'
CLR_GREEN='\033[38;5;82m'
CLR_YELLOW='\033[38;5;226m'
CLR_RED='\033[38;5;196m'
CLR_GREY='\033[38;5;244m'
CLR_WHITE='\033[38;5;255m'
CLR_BG='\033[48;5;234m'
NC='\033[0m'

mkdir -p "$RESULTS_DIR"
if [ ! -f "$HISTORY_FILE" ]; then
    echo "Timestamp,Target,Users,Duration,AvgLatency,Errors,Status,Path" > "$HISTORY_FILE"
fi

# --- UTILS ---
cleanup() {
    tput cnorm
    [ -f "$RUN_FILE" ] && rm -f "$RUN_FILE"
    [ -f "$TEMP_LOG" ] && rm -f "$TEMP_LOG"
}
trap cleanup EXIT INT TERM

draw_banner() {
    clear
    echo -e "${CLR_CYAN}┌──────────────────────────────────────────────────────────────────────┐"
    echo -e "│ ${BOLD}${CLR_WHITE}TECHTON ${CLR_CYAN}v1.0.0${NC}${CLR_CYAN}                                                       │"
    echo -e "│ ${CLR_GREY}Enterprise Grade Active Directory Resilience Audit Tool              ${CLR_CYAN}│"
    echo -e "└──────────────────────────────────────────────────────────────────────┘${NC}"
}

draw_main_menu() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}MAIN OPERATIONAL INTERFACE${NC}"
    echo -e " ${CLR_GREY}───────────────────────────${NC}"
    echo -e "  ${CLR_CYAN}[01]${NC} INITIALIZE NEW ATTACK VECTOR"
    echo -e "  ${CLR_CYAN}[02]${NC} ACCESS HISTORICAL AUDIT LOGS"
    echo -e "  ${CLR_CYAN}[03]${NC} MONITOR ACTIVE SUB-PROCESSES"
    echo -e "  ${CLR_CYAN}[04]${NC} TERMINATE SYSTEM SESSION"
    echo -e "\n ${CLR_GREY}Select module and press enter...${NC}"
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
}

# --- MODULES ---
view_history() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}HISTORICAL AUDIT LOGS${NC}"
    echo -e " ${CLR_GREY}─────────────────────${NC}"
    
    printf " ${BOLD}${CLR_CYAN}%-3s  %-15s  %-15s  %-6s  %-8s  %-8s${NC}\n" "ID" "TIMESTAMP" "TARGET" "LOAD" "LATENCY" "STATUS"
    echo -e " ${CLR_GREY}──────────────────────────────────────────────────────────────────────${NC}"
    
    mapfile -t lines < <(tail -n +2 "$HISTORY_FILE")
    if [ ${#lines[@]} -eq 0 ]; then
        echo -e " ${CLR_YELLOW}No records found in database.${NC}"
    else
        i=1
        for line in "${lines[@]}"; do
            IFS=',' read -r ts target users dur lat err stat path <<< "$line"
            case "$stat" in
                PASS)  s_color=$CLR_GREEN ;; 
                WARN)  s_color=$CLR_YELLOW ;; 
                *)     s_color=$CLR_RED ;; 
            esac
            short_ts=$(echo "$ts" | cut -d' ' -f1 | cut -d'-' -f2,3)" "$(echo "$ts" | cut -d' ' -f2)"
            printf " ${CLR_CYAN}%02d${NC}   %-15s  %-15s  %-6s  %-8s  ${s_color}%-8s${NC}\n" "$i" "$short_ts" "$target" "$users" "${lat}ms" "$stat"
            ((i++))
        done
    fi
    echo -e "\n ${CLR_GREY}Enter ID for report path or [q] to return...${NC}"
    printf " ${BOLD}${CLR_CYAN}>> ${NC}"
    read choice
    [[ "$choice" == "q" ]] && return
    
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -le "${#lines[@]}" ]; then
        index=$((choice-1))
        IFS=',' read -r ts target users dur lat err stat path <<< "${lines[$index]}"
        echo -e "\n ${BOLD}${CLR_WHITE}REPORT PATH:${NC} ${CLR_CYAN}$path${NC}"
        read -p " Press Enter to continue..."
    fi
}

check_processes() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}SYSTEM PROCESS MONITOR${NC}"
    echo -e " ${CLR_GREY}──────────────────────${NC}"
    
    active=$(docker ps --format "table {{.Names}}\t{{.Status}}" | grep "techton")
    if [ -z "$active" ]; then
        echo -e " ${CLR_GREEN}System status: Nominal. No active stress containers detected.${NC}"
    else
        echo -e " ${CLR_RED}Active stress sessions detected:${NC}"
        echo -e "$active"
        echo ""
        read -p " Terminate all active sessions? (y/n): " k
        if [[ "$k" == "y" ]]; then
            docker ps -q --filter "name=techton" | xargs -r docker stop &>/dev/null
            echo -e " ${CLR_GREEN}All sessions terminated successfully.${NC}"
        fi
    fi
    read -p " Press Enter to return..."
}

start_test() {
    draw_banner
    echo -e "\n ${BOLD}${CLR_WHITE}ATTACK VECTOR INITIALIZATION${NC}"
    echo -e " ${CLR_GREY}─────────────────────────────${NC}"
    
    # Inputs
    printf " ${CLR_WHITE}Target IP     ${NC}[${CLR_GREY}192.168.100.236${NC}]: " ; read t_ip ; t_ip=${t_ip:-192.168.100.236}
    printf " ${CLR_WHITE}Admin Account ${NC}[${CLR_GREY}tester${NC}]: " ; read u_name ; u_name=${u_name:-tester}
    
    def_dn="CN=$u_name,OU=User,OU=BRIN,DC=net,DC=brin,DC=go,DC=id"
    printf " ${CLR_WHITE}Account DN    ${NC}[${CLR_GREY}$def_dn${NC}]: " ; read u_dn ; u_dn=${u_dn:-$def_dn}
    
    printf " ${CLR_WHITE}Access Key    ${NC}: " ; read -s pass ; echo ""
    
    printf " ${CLR_WHITE}Load Intensity${NC}[${CLR_GREY}10 Threads${NC}]: " ; read threads ; threads=${threads:-10}
    
    # Calc
    rampup=$((threads / 5)); [ $rampup -lt 1 ] && rampup=1
    duration=$((rampup + 60)); [ $duration -lt 30 ] && duration=30
    
    printf " ${CLR_WHITE}Duration (s)  ${NC}[${CLR_GREY}$duration${NC}]: " ; read dur_in ; duration=${dur_in:-$duration}
    
    echo -e "\n ${CLR_CYAN}PRE-FLIGHT CHECK COMPLETED. SYSTEM READY.${NC}"
    read -p " Press Enter to engage..."
    
    # Execute
    TS=$(date +"%Y-%m-%d_%H-%M-%S")
    R_DIR="run_${TS}_${threads}u"
    C_R_DIR="$RESULTS_DIR/$R_DIR"
mkdir -p "$C_R_DIR"
    
    sed -e "s/__TARGET_IP__/$t_ip/g" -e "s/__ROOT_DN__/DC=net,DC=brin,DC=go,DC=id/g" \
        -e "s/__USER_DN__/$u_dn/g" -e "s/__PASSWORD__/$pass/g" \
        -e "s/__THREADS__/$threads/g" -e "s/__RAMPUP__/$rampup/g" \
        -e "s/__DURATION__/$duration/g" "$TEMPLATE_FILE" > "$RUN_FILE"

    tput civis
    docker run --rm --name "techton_${TS//[:_-]/}" -v "$PROJECT_ROOT:/tests" -w /tests \
      justb4/jmeter:5.5 -Jsummariser.interval=3 -n -t "results/run_current.jmx" \
      -l "results/$R_DIR/result.jtl" -e -o "results/$R_DIR/dashboard" 2>&1 | tee "$TEMP_LOG" | \
      awk -v target="$t_ip" -v users="$threads" -v duration="$duration" \
          -v c1="$CLR_CYAN" -v c2="$CLR_MAGENTA" -v c3="$CLR_GREEN" -v c4="$CLR_RED" \
          -v c5="$CLR_YELLOW" -v c6="$CLR_GREY" -v c7="$CLR_WHITE" -v nc="$NC" -v b="$BOLD" ' 
      BEGIN { start = systime() } 
      /summary \+/ { 
          now = systime(); elapsed = now - start; 
          if(elapsed > duration) elapsed = duration;
          pct = (elapsed/duration)*100; if(pct>100) pct=100;
          
          # Bar
          bw = 50; f = int((pct/100)*bw); bar="";
          for(i=0;i<f;i++) bar=bar "█"; for(i=f;i<bw;i++) bar=bar "░";
          
          # Data
          spd="0/s"; lat="0"; err="0";
          for(i=1;i<=NF;i++){
              if($i ~ /\/s$/) spd=$i; if($i == "Avg:") lat=$(i+1); if($i == "Err:") err=$(i+1);
          }
          
          # TUI
          printf "\033[2J\033[H"
          print c1 "┌──────────────────────────────────────────────────────────────────────┐"
          print "│ " b c7 "OPERATIONAL DASHBOARD" nc c1 "                                           │"
          print "├──────────────────────────────────────────────────────────────────────┤"
          printf "│  %-12s %-18s  %-10s %-20s │\n", "TARGET:", target, "LOAD:", users " THREADS"
          print "├──────────────────────────────────────────────────────────────────────┤"
          print "│                                                                      │"
          printf "│    %-18s      %-18s      %-18s  │\n", "THROUGHPUT", "LATENCY", "ERROR COUNT"
          printf "│    " c5 "%-18s" nc "      " c2 "%-18s" nc "      " (err>0?c4:c3) "%-18s" nc "  │\n", spd, lat " ms", err
          print "│                                                                      │"
          print "├──────────────────────────────────────────────────────────────────────┤"
          printf "│  PROGRESS: %3d%%  " c1 "[%s]" nc "  %4ds / %-4ds │\n", pct, bar, elapsed, duration
          print "└──────────────────────────────────────────────────────────────────────┘"
          fflush()
      }
      '
    tput cnorm

    # Analysis
    res=$(grep "summary =" "$TEMP_LOG" | tail -n 1)
    l=$(echo "$res" | awk -F 'Avg: ' '{print $2}' | awk '{print $1}'); l=${l:-0}
    e=$(echo "$res" | awk -F 'Err: ' '{print $2}' | awk '{print $1}'); e=${e:-0}
    s="PASS"; [ "$e" -gt 0 ] && s="FAIL"; [ "$s" == "PASS" ] && [ "$l" -gt 2000 ] && s="CRIT"; [ "$s" == "PASS" ] && [ "$l" -gt 500 ] && s="WARN";
    
    echo "$TS,$t_ip,$threads,$duration,$l,$e,$s,$C_R_DIR" >> "$HISTORY_FILE"
    echo -e "\n ${BOLD}${CLR_WHITE}MISSION COMPLETE.${NC} STATUS: ${BOLD}$s${NC}"
    read -p " Press Enter to return..."
}

# --- BOOT ---
while true; do
    draw_main_menu
    read choice
    case "$choice" in
        01|1) start_test ;;
        02|2) view_history ;;
        03|3) check_processes ;;
        04|4) exit 0 ;;
    esac
done
