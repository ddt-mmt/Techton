#!/bin/bash
# Monitor Techton Progress - Real Time with Remaining Time
TEMP_LOG="/tmp/techton_out.txt"
JS_FILE="/usr/lib/gemini-cli/techton-project/results/run_current.js"

# ANSI Colors
CLR_CYAN='\033[38;5;51m'
CLR_MAGENTA='\033[38;5;201m'
CLR_GREEN='\033[38;5;82m'
CLR_YELLOW='\033[38;5;226m'
CLR_RED='\033[38;5;196m'
CLR_WHITE='\033[38;5;255m'
CLR_GREY='\033[38;5;244m'
NC='\033[0m'
BOLD='\033[1m'

clear
tput civis # Hide cursor

# Helper to convert XmYs to seconds without bc
to_seconds() {
    local t=$1
    local m=0; local s=0
    if [[ $t =~ ([0-9]+)m([0-9.]+)s ]]; then
        m=${BASH_REMATCH[1]}
        s=$(echo ${BASH_REMATCH[2]} | cut -d'.' -f1)
    elif [[ $t =~ ([0-9.]+)s ]]; then
        s=$(echo ${BASH_REMATCH[1]} | cut -d'.' -f1)
    fi
    echo $(( m * 60 + s ))
}

while true; do
    if [ ! -f "$TEMP_LOG" ]; then
        echo -e "${CLR_RED}Waiting for log file...${NC}"
        sleep 1
        continue
    fi

    # Extract data from last 10 lines
    LAST_LINES=$(tail -n 10 "$TEMP_LOG")
    
    # K6 Parsing logic
    # Line format A: login_storm   [  83% ] 1600/1600 VUs  09m44.6s/11m45.0s
    # Line format B: running (0m17.0s), 10/10 VUs, 405 complete ...
    RAW_PROGRESS=$(echo "$LAST_LINES" | grep "[" | grep "%" | tail -n 1)
    RUNNING_LINE=$(echo "$LAST_LINES" | grep "running (" | tail -n 1)
    
    PERCENT=0
    ELAPSED="--"
    TOTAL="--"
    REMAINING="--"
    VUS="--"

    if [[ -n "$RAW_PROGRESS" ]]; then
        PERCENT=$(echo "$RAW_PROGRESS" | sed -n 's/.*[[[:space:]]*\([0-9]\+\)\%.*/\1/p')
        [[ -z "$PERCENT" ]] && PERCENT=0
        
        TIME_FIELD=$(echo "$RAW_PROGRESS" | awk '{print $NF}')
        
        if [[ "$TIME_FIELD" == *"/"* ]]; then
            ELAPSED=$(echo "$TIME_FIELD" | cut -d'/' -f1)
            TOTAL=$(echo "$TIME_FIELD" | cut -d'/' -f2)
            
            E_SEC=$(to_seconds "$ELAPSED")
            T_SEC=$(to_seconds "$TOTAL")
            R_SEC=$(( T_SEC - E_SEC ))
            [[ $R_SEC -lt 0 ]] && R_SEC=0
            
            REMAINING=$(printf "%02dm %02ds" $((R_SEC/60)) $((R_SEC%60)))
        fi
        VUS=$(echo "$RAW_PROGRESS" | awk '{for(i=1;i<=NF;i++) if($i ~ /VUs/) print $(i-1)}')
    elif [[ -n "$RUNNING_LINE" ]]; then
        # Format: running (1m13.2s), 00/20 VUs, 3788 complete
        if [[ "$RUNNING_LINE" =~ running\ \(([0-9]+m)?([0-9.]+)s\) ]]; then
            ELAPSED_RAW="${BASH_REMATCH[1]}${BASH_REMATCH[2]}s"
            ELAPSED=$ELAPSED_RAW
            E_SEC=$(to_seconds "$ELAPSED_RAW")
            
            # Try to find TOTAL from run_current.js
            if [[ -f "$JS_FILE" ]]; then
                # Extract durations from stages: { duration: '62s', target: 10 }
                T_SEC=$(grep "duration:" "$JS_FILE" | sed -n "s/.*'\(.*\)s'.*/\1/p" | awk '{sum+=$1} END {print sum}')
                
                if [[ $T_SEC -gt 0 ]]; then
                    R_SEC=$(( T_SEC - E_SEC ))
                    [[ $R_SEC -lt 0 ]] && R_SEC=0
                    PERCENT=$(( E_SEC * 100 / T_SEC ))
                    [[ $PERCENT -gt 100 ]] && PERCENT=100
                    REMAINING=$(printf "%02dm %02ds" $((R_SEC/60)) $((R_SEC%60)))
                fi
            fi
        fi
        VUS=$(echo "$RUNNING_LINE" | sed -n 's/.*, \([0-9]\+\/[0-9]\+ VUs\).*/\1/p')
    fi

    if [[ "$ELAPSED" != "--" ]]; then
        # Draw Dashboard
        printf "\033[2J\033[H"
        echo -e "${CLR_CYAN}┌──────────────────────────────────────────────────────────────────────┐"
        echo -e "│ ${BOLD}${CLR_WHITE}TECHTON LIVE MONITOR${NC}${CLR_CYAN}                                               │"
        echo -e "├──────────────────────────────────────────────────────────────────────┤"
        printf "│  %-15s %-48b │\n" "STATUS:" "${CLR_GREEN}RUNNING${NC}"
        printf "│  %-15s %-48b │\n" "ACTIVE VUs:" "${CLR_YELLOW}${VUS:-'--'}${NC}"
        printf "│  %-15s %-48b │\n" "ELAPSED:" "${CLR_WHITE}${ELAPSED}${NC}"
        printf "│  %-15s %-48b │\n" "SISA DURASI:" "${CLR_RED}${BOLD}${REMAINING}${NC}"
        echo -e "├──────────────────────────────────────────────────────────────────────┤"
        
        # Progress Bar
        BAR_WIDTH=50
        FILLED=$(( PERCENT * BAR_WIDTH / 100 ))
        EMPTY=$(( BAR_WIDTH - FILLED ))
        BAR=$(printf "%${FILLED}s" | tr ' ' '█')
        DOTS=$(printf "%${EMPTY}s" | tr ' ' '░')
        
        printf "│  PROGRESS: %3d%%  ${CLR_CYAN}[%s%s]${NC}  │\n" "$PERCENT" "$BAR" "$DOTS"
        echo -e "└──────────────────────────────────────────────────────────────────────┘${NC}"
    else
        echo -e "${CLR_RED}Waiting for k6 engine to warm up...${NC}"
    fi

    sleep 1
done
